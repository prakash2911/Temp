package com.example.demo.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.web.bind.annotation.*;

import java.util.*;

@RestController
@RequestMapping("/api/trades")
@CrossOrigin(origins = "*")
public class TradeController {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @GetMapping
    public Map<String, Object> getTrades(
        @RequestParam String serviceName, 
        @RequestParam List<String> sourceIds,
        @RequestParam int page,
        @RequestParam int size
    ) {
        int offset = page * size;
        int limit = size;

        // Constructing the Oracle SQL query with pagination
        String sql = "SELECT * FROM (" +
                     "    SELECT t.*, ROWNUM AS rn FROM (" +
                     "        SELECT * FROM tradeview WHERE servicename = ? " +
                     "        AND source_id IN (" + String.join(",", Collections.nCopies(sourceIds.size(), "?")) + ") " +
                     "        ORDER BY trade_date DESC" +
                     "    ) t WHERE ROWNUM <= ?" +
                     ") WHERE rn > ?";

        List<Object> params = new ArrayList<>();
        params.add(serviceName);
        params.addAll(sourceIds);
        params.add(offset + limit); // Upper limit
        params.add(offset); // Lower limit

        List<Map<String, Object>> result = jdbcTemplate.queryForList(sql, params.toArray());

        // Generating dynamic headers
        List<Map<String, String>> headers = new ArrayList<>();
        if (!result.isEmpty()) {
            for (String key : result.get(0).keySet()) {
                if (!key.equals("RN")) { // Ignore row number column
                    Map<String, String> header = new HashMap<>();
                    header.put("columnName", key);
                    headers.add(header);
                }
            }
        }

        // Getting the total count of records
        String countSql = "SELECT COUNT(*) FROM tradeview WHERE servicename = ? " +
                          "AND source_id IN (" + String.join(",", Collections.nCopies(sourceIds.size(), "?")) + ")";
        int total = jdbcTemplate.queryForObject(countSql, Integer.class, params.subList(0, params.size() - 2).toArray());

        // Preparing res
